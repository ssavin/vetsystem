Техническое задание: Модуль «Стационар»
1. Цель и назначение модуля
Разработать бэкенд-компонент для управления пациентами, находящимися на стационарном лечении. Модуль должен автоматизировать учет проводимых манипуляций, контроль за состоянием животных и, самое главное, автоматическое добавление услуг в накопительный счет пациента.

2. Интеграция с существующей системой
Модуль будет работать в рамках уже спроектированного API и активно использовать следующие сущности:

Patients: для привязки животного к месту в стационаре.

Services: для получения информации об услугах (например, "Сутки содержания в стационаре", "Внутривенная инъекция") и их стоимости.

Invoices: для автоматического пополнения счета пациента. Каждому активному стационарному пребыванию будет соответствовать один счет в статусе draft.

3. Новые модели данных
Для реализации функционала потребуются новые сущности в базе данных:

Cages (Клетки/Боксы): Справочник мест в стационаре.

id (уникальный идентификатор)

name (название/номер, например, "Бокс 3", "VIP-палата", строка)

status (статус: available, occupied, maintenance, строка)

HospitalStays (Пребывания в стационаре): Основная сущность, фиксирующая факт госпитализации.

id (уникальный идентификатор)

patient_id (ссылка на Patients.id)

cage_id (ссылка на Cages.id)

active_invoice_id (ссылка на Invoices.id - ключевая связь для биллинга)

status (статус: active, discharged, строка)

admitted_at (время поступления, timestamp)

discharged_at (время выписки, timestamp, nullable)

TreatmentLog (Журнал манипуляций): Записи о всех выполненных процедурах.

id (уникальный идентификатор)

hospital_stay_id (ссылка на HospitalStays.id)

service_id (ссылка на Services.id, оказанная услуга)

performer_name (имя сотрудника, выполнившего процедуру, строка)

performed_at (точное время выполнения, timestamp)

notes (заметки, например, "Препарат введен в правую лапу", строка, nullable)

4. API Эндпоинты (Маршруты)
4.1. Управление местами в стационаре (/cages)

GET /cages: Получить список всех мест и их статусы.

POST /cages: Создать новое место.

PUT /cages/{cage_id}: Изменить информацию о месте (например, название).

4.2. Управление госпитализацией (/hospital-stays)

POST /hospital-stays

Действие: Госпитализировать пациента. Это транзакционная операция.

Входные данные (JSON): { "patient_id": "...", "cage_id": "..." }

Внутренняя логика сервиса:

Проверить, свободна ли клетка (Cage.status == 'available'). Если нет - ошибка.

Создать новый счет (Invoice) для этого пациента со статусом draft (через POST /invoices).

Создать новую запись HospitalStay, связав ее с пациентом, клеткой и созданным счетом.

Изменить статус клетки на occupied.

Автоматически добавить в созданный счет первую услугу "Сутки содержания в стационаре" (ID услуги должен быть в конфигурации).

Ответ: Полный объект созданного HospitalStay.

GET /hospital-stays?status=active

Действие: Получить список всех пациентов, находящихся в стационаре в данный момент.

Ответ: Массив объектов HospitalStay с вложенной информацией о пациенте и клетке.

PATCH /hospital-stays/{stay_id}

Действие: Выписать пациента.

Входные данные (JSON): { "status": "discharged" }

Внутренняя логика сервиса:

Обновить запись HospitalStay, установив status = 'discharged' и discharged_at = NOW().

Освободить клетку, установив Cage.status = 'available'.

Важно: Счет (Invoice) не финализируется здесь. Он остается в статусе draft для окончательного расчета на ресепшене.

Ответ: Обновленный объект HospitalStay.

4.3. Ведение журнала манипуляций (/hospital-stays/{stay_id}/log)

POST /hospital-stays/{stay_id}/log

Действие: Зафиксировать выполнение процедуры и автоматически добавить ее в счет.

Входные данные (JSON): { "service_id": "...", "performer_name": "Врач Иванов", "notes": "..." }

Внутренняя логика сервиса:

Найти активное пребывание по stay_id.

Получить active_invoice_id из записи HospitalStay.

Создать запись в TreatmentLog.

Сделать внутренний API-запрос POST /invoices/{active_invoice_id}/items с { "service_id": "..." }, чтобы добавить услугу в счет.

Ответ: Объект созданной записи TreatmentLog.

GET /hospital-stays/{stay_id}/log

Действие: Получить всю историю манипуляций для конкретного пациента за время его пребывания.

Ответ: Массив объектов TreatmentLog.

5. Автоматизированные процессы (фоновый агент)
Необходимо реализовать фоновую задачу (cron job), которая будет выполняться на Replit один раз в сутки.

Название задачи: Daily Inpatient Billing

Время запуска: Каждый день в 00:05.

Логика:

Агент запрашивает всех пациентов со статусом active (GET /hospital-stays?status=active).

Для каждого такого пациента он берет active_invoice_id.

Он делает внутренний запрос POST /invoices/{active_invoice_id}/items с service_id услуги "Сутки содержания в стационаре".

Таким образом, каждый день пребывания автоматически добавляется в счет.

6. Сценарий использования (User Flow)
Поступление: Администратор через интерфейс госпитализирует кота "Барсика" в Бокс 3. Фронтенд шлет POST /hospital-stays. Бэкенд создает запись о пребывании, связывает ее с новым счетом и автоматически добавляет в счет "Сутки содержания".

Лечение: В 10:00 медсестра делает "Барсику" укол. Она в планшете нажимает кнопку "Выполнить инъекцию". Фронтенд шлет POST /hospital-stays/{barsik_stay_id}/log. Бэкенд фиксирует процедуру в журнале и тут же добавляет услугу "Инъекция" в счет "Барсика".

Ежедневное списание: В 00:05 ночи фоновый агент находит "Барсика" в стационаре и автоматически добавляет в его счет еще одни "Сутки содержания".

Выписка: Через 3 дня врач решает выписать "Барсика". Он нажимает "Выписать". Фронтенд шлет PATCH /hospital-stays/{barsik_stay_id}. Бэкенд меняет статус пребывания и освобождает бокс.

Расчет: Владелец приходит на ресепшен. Администратор видит в списке счетов к оплате счет "Барсика", в котором уже накоплено: 3 х "Сутки содержания", 5 х "Инъекция" и т.д. Он финализирует счет и принимает оплату.