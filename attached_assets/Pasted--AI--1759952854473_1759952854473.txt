Техническое Задание для AI-агента: Интеграция с ГИС "ВетИС Гален"
Цель: Разработать модуль для двусторонней интеграции платформы VetSystem с государственной системой "ВетИС Гален". Цель — автоматизировать регистрацию животных, учет вакцинаций (особенно от бешенства) и получение ветеринарных сопроводительных документов (эВСД) непосредственно из интерфейса программы, минимизируя ручной ввод и обеспечивая соответствие законодательству РФ.

Важное предварительное условие: Каждая клиника-арендатор (tenant) должна самостоятельно получить свои учетные данные для доступа к API "ВетИС Гален" от Россельхознадзора. Наша задача — создать интерфейс для безопасного хранения и использования этих данных.

Часть 1: Проектирование Базы Данных и Безопасность (PostgreSQL / Drizzle ORM)
Необходимо расширить существующие модели для хранения учетных данных и статусов синхронизации.

Модификация модели tenants (или создание связанной tenant_settings):

Добавить поля для хранения учетных данных доступа к API "Гален". Эти данные должны храниться в зашифрованном виде в базе данных.

galen_api_user (VARCHAR, зашифрованный)

galen_api_key (VARCHAR, зашифрованный)

galen_issuer_id (VARCHAR, зашифрованный, ID хозяйствующего субъекта)

galen_service_id (VARCHAR, зашифрованный, ID сервиса)

Модификация модели patients:

Добавить поля для связи записи о животном в нашей системе с записью в "Гален".

galen_uuid (UUID, может быть NULL) — Уникальный идентификатор животного в системе "Гален".

galen_sync_status (ENUM: 'not_synced', 'sync_in_progress', 'synced', 'error'), default 'not_synced'.

galen_last_sync_error (TEXT, может быть NULL) — Текст последней ошибки синхронизации.

galen_last_sync_at (TIMESTAMP)

Задача для AI:

Создай миграцию Drizzle ORM для добавления указанных полей в таблицы tenants и patients.

На бэкенде (в Express) реализуй логику шифрования/дешифрования учетных данных "Гален" при их сохранении и извлечении из БД. Используй встроенный в Node.js модуль crypto. Ключ для шифрования должен храниться безопасно (например, в переменных окружения сервера).

Часть 2: Архитектура Бэкенда (Express / TypeScript)
Это ядро интеграции. Вся коммуникация с внешним API должна происходить исключительно на бэкенде, чтобы не раскрывать учетные данные на клиенте.

Создание GalenAPIService.ts:

Назначение: Создать отдельный сервис-класс, который инкапсулирует всю логику взаимодействия с API "Гален". Этот сервис будет отвечать за:

Формирование запросов (вероятно, в формате XML/SOAP, что типично для ГИС).

Аутентификацию с использованием учетных данных арендатора.

Отправку запросов к API "Гален".

Парсинг ответов.

Обработку специфических кодов ошибок "Гален".

Методы (примеры):

registerAnimal(patientData, credentials)

recordVaccination(galenUuid, vaccinationData, credentials)

checkAnimalStatus(galenUuid, credentials)

Создание новых API Эндпоинтов:

PUT /api/tenant/settings/galen:

Описание: Сохранение учетных данных "Гален" для текущего арендатора.

Request Body: { galen_api_user, galen_api_key, ... }.

Логика: Принимает данные, шифрует их и сохраняет в таблицу tenants. Доступно только для роли "администратор клиники".

POST /api/patients/:patientId/galen/register:

Описание: Зарегистрировать пациента в системе "Гален".

Логика:

Получить tenant_id из JWT.

Извлечь и расшифровать учетные данные "Гален" для этого tenant_id.

Получить данные о пациенте (patientId) из своей БД.

Вызвать метод GalenAPIService.registerAnimal().

В случае успеха: получить galen_uuid от "Гален", обновить запись в таблице patients (установить galen_uuid, galen_sync_status = 'synced').

В случае ошибки: обновить запись в patients (статус 'error', записать текст ошибки).

Вернуть на фронтенд актуальный статус.

POST /api/patients/:patientId/galen/vaccinations:

Описание: Отправить данные о проведенной вакцинации в "Гален".

Request Body: { vaccination_name, series, date, doctor_id }.

Логика: Аналогична регистрации, но вызывает метод GalenAPIService.recordVaccination(). Требует наличия galen_uuid у пациента.

Задача для AI:

Создай каркас сервиса GalenAPIService.ts. Поскольку реальный API "Гален" недоступен, создай mock-методы, которые имитируют успешный ответ (возвращают фейковый UUID) или ошибку.

Реализуй эндпоинты PUT /api/tenant/settings/galen и POST /api/patients/:patientId/galen/register с полной логикой (получение tenant_id, работа с БД, вызов mock-сервиса).

Используй Zod для валидации всех входящих запросов.

Часть 3: Архитектура Фронтенда (React / TypeScript)
Интеграция должна быть встроена в существующие интерфейсы.

Компонент TenantSettingsGalen.tsx:

Назначение: Форма для ввода и сохранения учетных данных "Гален".

Расположение: В разделе настроек клиники (доступно для администраторов).

UI: Используй Input и PasswordInput от Shadcn/ui для полей. Кнопка "Сохранить".

Логика: Используй React Hook Form с Zod для валидации. При сабмите, вызови useMutation от TanStack Query для отправки данных на эндпоинт PUT /api/tenant/settings/galen. Отображай Toast (уведомление) об успехе или ошибке.

Компонент-виджет GalenIntegrationWidget.tsx:

Назначение: Компактный виджет для отображения статуса и управления синхронизацией с "Гален".

Расположение: Внутри страницы "Медицинская карта пациента" (PatientMedicalRecord.tsx).

UI и Логика:

Получает в props данные о пациенте, включая galen_sync_status, galen_uuid, galen_last_sync_error.

Условное отображение:

Если status == 'not_synced': Показывает кнопку Button "Зарегистрировать в Гален".

Если status == 'sync_in_progress': Показывает спиннер Loader.

Если status == 'synced': Показывает зеленую иконку с текстом "Синхронизировано" и UUID из "Гален". Появляется кнопка "Зарегистрировать вакцинацию".

Если status == 'error': Показывает красную иконку с текстом ошибки и кнопку "Повторить попытку".

Действия: Каждая кнопка ("Зарегистрировать", "Повторить") триггерит соответствующий useMutation, который вызывает API бэкенда. Мутация должна обновлять данные пациента (invalidateQueries от TanStack Query), чтобы виджет автоматически обновил свой вид.

Задача для AI:

Создай компонент TenantSettingsGalen.tsx.

Создай виджет GalenIntegrationWidget.tsx с описанной выше логикой условного рендеринга.

Интегрируй GalenIntegrationWidget.tsx в существующий компонент PatientMedicalRecord.tsx.

Реализуй useMutation хуки для вызова бэкенд-эндпоинтов, включая обновление состояния через invalidateQueries.

Первоочередная Задача для AI-агента
Начни с Части 1 и 2.

Реализуй миграции для БД.

Создай эндпоинт для сохранения учетных данных PUT /api/tenant/settings/galen, включая логику шифрования.

Создай mock-сервис GalenAPIService.ts и эндпоинт для регистрации пациента POST /api/patients/:patientId/galen/register.

После этого можно будет реализовать фронтенд для ввода настроек и тестового "запуска" регистрации.