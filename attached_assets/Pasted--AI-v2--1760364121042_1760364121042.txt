Техническое Задание для AI-агента: Расширение Клиентского Мобильного Приложения (v2)
Общая цель: Превратить мобильное приложение VetSystem из инструмента для записи в полноценный медицинский хаб для клиента. Предоставить доступ ко всей истории болезни питомца, включая анализы и снимки, наладить проактивное информирование о процедурах и создать канал для прямой коммуникации с клиникой.

Часть 1: Модификация Базы Данных (PostgreSQL / Drizzle ORM)
Необходимо добавить таблицы для реализации функции чата.

Модель conversations (Чаты/Диалоги):

id (PRIMARY KEY, UUID)

tenant_id (FOREIGN KEY к tenants.id, обязательно для RLS)

owner_id (FOREIGN KEY к owners.id)

subject (VARCHAR, тема диалога, напр. "Вопрос по результатам анализов Барсика")

status (ENUM: 'open', 'closed_by_client', 'closed_by_staff'), default 'open'

created_at, updated_at (TIMESTAMPS)

Модель messages (Сообщения в чате):

id (PRIMARY KEY, UUID)

conversation_id (FOREIGN KEY к conversations.id)

sender_id (UUID, ID отправителя. Может быть owner_id или user_id сотрудника)

sender_type (ENUM: 'client', 'staff')

message_text (TEXT, текст сообщения)

is_read (BOOLEAN, default false)

created_at (TIMESTAMP)

Задача для AI: На основе этого описания, создай миграцию Drizzle ORM для добавления таблиц conversations и messages.

Часть 2: Архитектура Бэкенда (Express.js)
Необходимо создать новые и расширить существующие API-эндпоинты для поддержки нового функционала.

Доступ к Медицинским данным:

Эндпоинт: GET /api/mobile/encounters/:encounterId/attachments

Описание: Получение списка всех прикрепленных файлов (анализы, снимки) для конкретного обследования/приема.

Логика: Эндпоинт должен вернуть массив объектов, где каждый объект содержит id, file_name, mime_type и, самое главное, безопасный, временно сгенерированный URL для скачивания файла из вашего облачного хранилища (например, pre-signed URL для Amazon S3).

Чат и Коммуникации:

Эндпоинт: GET /api/mobile/me/conversations (Получить список чатов)

Эндпоинт: POST /api/mobile/me/conversations (Начать новый чат)

Эндпоинт: GET /api/mobile/conversations/:conversationId/messages (Получить сообщения чата)

Эндпоинт: POST /api/mobile/conversations/:conversationId/messages (Отправить сообщение)

Логика: Реализовать стандартную CRUD-логику для чата. При отправке сообщения от сотрудника клиники, система должна триггерить отправку push-уведомления на устройство клиента.

Проактивные Уведомления (Логика для CRON-задачи):

Задача для AI: Модифицируй существующую фоновую задачу (CRON job). Помимо напоминаний о записи, она должна:

Проверять даты последних вакцинаций: Находить пациентов, у которых подходит срок ревакцинации (например, last_vaccination_date + 11 месяцев).

Проверять плановые процедуры: Искать в медицинских картах записи о рекомендованных, но еще не выполненных процедурах (например, плановая стерилизация).

Для каждого найденного случая создавать запись-уведомление в специальной таблице и отправлять push-уведомление на устройство клиента с текстом вроде "Не забудьте о плановой вакцинации для Барсика!".

Часть 3: Разработка Мобильного Приложения (React Native / Expo)
Необходимо добавить новые экраны и расширить существующие.

Расширение Экрана "История Болезни" (PetDetailScreen.tsx):

UI: Список визитов (обследований) должен стать интерактивным.

Логика: При нажатии на визит, пользователь переходит на новый экран EncounterDetailScreen.

Новый Экран EncounterDetailScreen.tsx (Детали Визита):

UI: Отображает всю информацию по визиту: диагноз, назначения и новый раздел "Прикрепленные файлы".

Раздел "Прикрепленные файлы":

Используй useQuery для запроса на GET /api/mobile/encounters/:encounterId/attachments.

Отображай список файлов с иконками в зависимости от mime_type (PDF, JPG и т.д.).

Логика: При нажатии на файл, используй Expo File System и Expo Sharing для скачивания и открытия файла на устройстве пользователя.

Новая секция "Чат с клиникой":

Новый Экран ConversationsListScreen.tsx (Список диалогов):

UI: Список всех диалогов пользователя с клиникой, с отображением темы, последнего сообщения и индикатора непрочитанных сообщений. Кнопка "Начать новый диалог".

Логика: useQuery для GET /api/mobile/me/conversations.

Новый Экран ChatScreen.tsx (Экран Чата):

UI: Классический интерфейс чата. Используй библиотеку, например, react-native-gifted-chat, для быстрой реализации.

Логика: Загрузка сообщений с GET /api/mobile/conversations/:conversationId/messages. Отправка новых сообщений через useMutation на POST эндпоинт.

Новый Экран "Уведомления / План здоровья" (HealthPlanScreen.tsx):

UI: Список карточек с проактивными напоминаниями, полученными через push-уведомления (о вакцинациях, процедурах).

Логика: Этот экран может отображать данные, которые приходят с push-уведомлениями, или делать отдельный запрос на специальный эндпоинт, который собирает все предстоящие "события" для питомцев клиента.